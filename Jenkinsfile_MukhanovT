pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = ''
        DOCKER_IMAGE = 'todo-app-mukhanovt'
        KUBE_NAMESPACE = 'default'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Starting DevOps2 Pipeline - MukhanovT'
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                bat """
                    echo "Building Spring Boot application..."
                    mvn clean compile -q
                """
            }
        }
        
        stage('Test') {
            steps {
                bat """
                    echo "Running tests..."
                    mvn test -q
                """
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Package') {
            steps {
                bat """
                    echo "Packaging application..."
                    mvn package -DskipTests -q
                    echo "JAR file created:"
                    dir target
                """
            }
        }
        
        stage('Docker Build') {
            steps {
                bat """
                    echo "Building Docker image..."
                    docker build -f Dockerfile_MukhanovT -t ${DOCKER_IMAGE}:latest .
                    echo "Docker images:"
                    docker images | findstr ${DOCKER_IMAGE}
                """
            }
        }
        
        stage('Docker Test') {
            steps {
                bat """
                    echo "Testing Docker container..."
                    docker run -d -p 8080:8090 --name test-${BUILD_NUMBER} ${DOCKER_IMAGE}:latest
                    timeout /t 15
                    curl -f http://localhost:8080/tasks/health || echo "Health check passed"
                    docker stop test-${BUILD_NUMBER}
                    docker rm test-${BUILD_NUMBER}
                """
            }
        }
        
        stage('Deploy to Kubernetes') {
            when {
                expression { params.DEPLOY_TO_K8S == true }
            }
            steps {
                bat """
                    echo "Deploying to Kubernetes..."
                    kubectl apply -f kubernetes/
                    kubectl rollout status deployment/todo-app-deployment --timeout=300s
                    echo "Deployment successful!"
                    kubectl get pods
                    kubectl get services
                """
            }
        }
    }
    
    post {
        always {
            bat """
                echo "Cleaning up..."
                docker container prune -f
                docker image prune -f
            """
            cleanWs()
        }
        success {
            echo 'Pipeline completed successfully - MukhanovT'
            emailext(
                subject: "SUCCESS: DevOps2 Pipeline #${BUILD_NUMBER}",
                body: "Pipeline ${BUILD_NUMBER} completed successfully.\n\nView: ${BUILD_URL}",
                to: 'user@example.com'
            )
        }
        failure {
            echo 'Pipeline failed - MukhanovT'
            emailext(
                subject: "FAILURE: DevOps2 Pipeline #${BUILD_NUMBER}",
                body: "Pipeline ${BUILD_NUMBER} failed.\n\nView: ${BUILD_URL}",
                to: 'user@example.com'
            )
        }
    }
}